<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR/바코드 로그인</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 16px; }
    #reader { position: relative; max-width: 480px; margin: 0 auto; }
    video { width: 100%; border-radius: 12px; }
    .btn { display:inline-block; padding:12px 16px; margin:8px 4px; border:0; border-radius:10px; background:#111; color:#fff; font-weight:600 }
    .muted { color:#666; font-size:14px; margin-top:8px }
    #result { margin-top: 12px; font-weight: 600; }
  </style>
</head>
<body>
  <h2>카메라로 QR/바코드 스캔</h2>
  <div id="reader">
    <video id="preview" autoplay muted playsinline></video>
  </div>
  <div>
    <button class="btn" id="startBtn">카메라 시작</button>
    <button class="btn" id="stopBtn" disabled>정지</button>
  </div>
  <div class="muted">카메라 권한이 필요합니다. HTTPS 환경에서 동작합니다.</div>
  <div id="result"></div>

  <!-- ZXing JS (ESM) -->
  <script type="module">
    import {
      BrowserMultiFormatReader,
      NotFoundException
    } from "https://cdn.jsdelivr.net/npm/@zxing/library@latest/+esm";

    const videoEl = document.getElementById('preview');
    const startBtn = document.getElementById('startBtn');
    const stopBtn  = document.getElementById('stopBtn');
    const resultEl = document.getElementById('result');

    const reader = new BrowserMultiFormatReader();
    let stream = null;
    let scanning = false;

    async function startCamera() {
      try {
        // 후면 카메라 우선 시도
        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: { exact: "environment" } }, audio: false
          });
        } catch (e) {
          // 실패 시 일반 카메라
          stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        }
        videoEl.srcObject = stream;
        await videoEl.play();
        scanning = true;
        scanLoop();
        startBtn.disabled = true;
        stopBtn.disabled = false;
        resultEl.textContent = "스캔 대기 중...";
      } catch (err) {
        console.error(err);
        resultEl.textContent = "카메라 접근 실패: 권한 또는 브라우저 설정을 확인하세요.";
      }
    }

    async function stopCamera() {
      scanning = false;
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      startBtn.disabled = false;
      stopBtn.disabled = true;
      resultEl.textContent = "정지됨";
    }

    async function scanLoop() {
      while (scanning) {
        try {
          const res = await reader.decodeOnceFromVideoElement(videoEl);
          const text = res.getText();
          await onScanSuccess(text);
          // 단발 스캔 후 자동 정지 (원한다면 제거)
          await stopCamera();
        } catch (err) {
          if (err instanceof NotFoundException) {
            // 프레임에서 아직 못 찾음 → 계속 루프
          } else {
            console.warn("디코드 오류:", err);
          }
          // 60fps 과도 방지
          await new Promise(r => setTimeout(r, 80));
        }
      }
    }

    async function onScanSuccess(codeText) {
      resultEl.textContent = "읽은 값: " + codeText;
      try {
        // 서버로 전송 (토큰/ID를 전달)
        const resp = await fetch("/api/qr-login/claim", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include", // 세션 쿠키 설정 시
          body: JSON.stringify({
            code: codeText,
            // 선택: 간단한 클라이언트 정보
            userAgent: navigator.userAgent
          })
        });
        if (resp.ok) {
          // 로그인 성공 → 메인 페이지로 이동
          window.location.href = "/"; // 필요 경로로 변경
        } else {
          const msg = await resp.text();
          resultEl.textContent = "로그인 실패: " + msg;
        }
      } catch (e) {
        console.error(e);
        resultEl.textContent = "네트워크 오류로 로그인 실패";
      }
    }

    startBtn.addEventListener('click', startCamera);
    stopBtn.addEventListener('click', stopCamera);
  </script>

  <!-- (폴백) 이미지 업로드로 스캔: 오래된 기기/권한 거부 대응
  <input type="file" accept="image/*" capture="environment" />
  업로드 후 서버에서 ZXing으로 해독하는 엔드포인트를 추가할 수 있습니다.
  -->
</body>
</html>
